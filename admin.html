<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf League Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #01422c, #255946);
            min-height: 100vh;
            color: #020c05;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #020c05;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #808381;
            font-size: 1.1em;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #808381;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: #77dd3c;
            color: #020c05;
        }

        .nav-tab:hover:not(.active) {
            background: rgba(119, 221, 60, 0.1);
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .section-title {
            color: #020c05;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #77dd3c;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #020c05;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d5d6d5;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: 'Inter', sans-serif;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #77dd3c;
            box-shadow: 0 0 0 3px rgba(119, 221, 60, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #77dd3c, #255946);
            color: #020c05;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #255946, #77dd3c);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger {
            background: #6b0005;
            color: white;
        }

        .btn-danger:hover {
            background: #8b0007;
        }

        .btn-secondary {
            background: #d5d6d5;
            color: #020c05;
        }

        .btn-secondary:hover {
            background: #aaacab;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-card {
            background: #f5f7f8;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #77dd3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-info h3 {
            color: #020c05;
            margin-bottom: 5px;
        }

        .player-info p {
            color: #808381;
            font-size: 0.9em;
        }

        .player-actions {
            display: flex;
            gap: 10px;
        }

        .match-queue {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .match-card {
            background: #f5f7f8;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #77dd3c;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .match-number {
            font-weight: 600;
            color: #020c05;
        }

        .match-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .match-status.pending {
            background: #f0faf2;
            color: #256a33;
        }

        .match-status.active {
            background: #f0faf2;
            color: #256a33;
        }

        .match-status.completed {
            background: #d5d6d5;
            color: #808381;
        }

        .match-players {
            font-weight: 600;
            color: #020c05;
            margin-bottom: 15px;
        }

        .match-actions {
            display: flex;
            gap: 10px;
        }

        .page-nav {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .page-nav-btn {
            background: #f5f7f8;
            color: #020c05;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .page-nav-btn:hover {
            background: #77dd3c;
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #808381;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #020c05;
        }

        .user-select-container {
            background: #f5f7f8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .user-select-container h3 {
            margin-bottom: 15px;
            color: #020c05;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f5f7f8;
            border-radius: 15px;
            border-left: 4px solid #77dd3c;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #020c05;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #808381;
            font-size: 0.9em;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .match-queue {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèåÔ∏è Golf League Administration</h1>
            <p>Add Players from Users and Manage Tournament</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('players')">üë• Players</button>
            <button class="nav-tab" onclick="showTab('matches')">üèåÔ∏è Matches</button>
            <button class="nav-tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Players Tab -->
        <div id="players-tab" class="tab-content active">
            <h2 class="section-title">Player Management</h2>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalPlayers">0</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="checkedInPlayers">0</div>
                    <div class="stat-label">Checked In</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">Available Users</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="availableUsers">0</div>
                    <div class="stat-label">Can Add</div>
                </div>
            </div>

            <div class="user-select-container">
                <h3>Add Player from Users</h3>
                <div class="form-group">
                    <label for="userSelect">Select User to Add as Player:</label>
                    <select id="userSelect" style="margin-bottom: 15px;">
                        <option value="">-- Select a user --</option>
                    </select>
                    <button class="btn" onclick="addSelectedUserAsPlayer()">Add as Player</button>
                </div>
            </div>

            <div class="players-grid" id="playersList">
                <!-- Players will be populated here -->
            </div>
        </div>

        <!-- Matches Tab -->
        <div id="matches-tab" class="tab-content">
            <h2 class="section-title">Match Management</h2>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="generateMatches()">Generate New Matches</button>
                <button class="btn btn-small btn-secondary" onclick="clearMatches()" style="margin-left: 10px;">Clear All Matches</button>
            </div>

            <div id="matchQueue" class="match-queue">
                <!-- Matches will be populated here -->
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <h2 class="section-title">Tournament Settings</h2>
            
            <div class="form-group">
                <label for="tournamentName">Tournament Name</label>
                <input type="text" id="tournamentName" value="Golf League Tournament">
            </div>

            <div class="form-group">
                <label for="minMatches">Minimum Matches per Player</label>
                <input type="number" id="minMatches" value="3" min="1" max="10">
            </div>

            <div class="form-group">
                <label for="tournamentNotes">Tournament Notes</label>
                <textarea id="tournamentNotes" rows="4" placeholder="Add any special rules or notes..."></textarea>
            </div>

            <div style="margin-top: 30px;">
                <button class="btn" onclick="saveSettings()">Save Settings</button>
                <button class="btn btn-small btn-secondary" onclick="exportData()" style="margin-left: 10px;">Export Data</button>
            </div>
        </div>

        <div class="page-nav">
            <button class="page-nav-btn" onclick="window.location.href='scoring.html'">üìä Scoring</button>
            <button class="page-nav-btn" onclick="window.location.href='leaderboard.html'">üèÜ Leaderboard</button>
        </div>
    </div>

    <script src="airtable-api.js"></script>
    <script>
        // Global variables
        let players = [];
        let matches = [];
        let leaderboard = [];
        let checkedInPlayers = [];
        let matchQueue = [];
        let currentMatchIndex = 0;
        let settings = {
            tournamentName: 'Golf League Tournament',
            minMatches: 3,
            notes: ''
        };
        let users = [];

        // Load data from Airtable
        async function loadData() {
            try {
                console.log('Starting to load data...');
                const data = await airtableAPI.getAllData();
                console.log('All data loaded:', data);
                
                players = data.players || [];
                matches = data.matches || [];
                leaderboard = data.leaderboard || [];
                checkedInPlayers = data.checkedInPlayers || [];
                matchQueue = data.matchQueue || [];
                currentMatchIndex = data.currentMatchIndex || 0;
                
                console.log('Players loaded:', players.length);
                console.log('Checked in players:', checkedInPlayers.length);
                
                // Load users for player selection
                try {
                    console.log('Loading users...');
                    const usersResponse = await airtableAPI.getUsers();
                    console.log('Raw users response:', usersResponse);
                    users = Array.isArray(usersResponse) ? usersResponse : [];
                    console.log('Users loaded successfully:', users.length);
                    console.log('First few users:', users.slice(0, 3));
                } catch (error) {
                    console.error('Failed to load users:', error);
                    console.error('Error details:', {
                        message: error.message,
                        stack: error.stack
                    });
                    users = [];
                }
                
                // Load settings
                try {
                    const settingsData = await airtableAPI.getSettings();
                    settings = { ...settings, ...settingsData };
                } catch (error) {
                    console.log('Using default settings');
                }
                
                updateDisplay();
                updateUserSelect();
                updateStats();
            } catch (error) {
                console.error('Failed to load data:', error);
                console.error('Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                alert('Failed to load data from server. Please check your connection.');
            }
        }

        // Update user selection dropdown
        function updateUserSelect() {
            const userSelect = document.getElementById('userSelect');
            const existingPlayerUserIds = players.map(p => p.user?.id).filter(id => id);
            
            console.log('=== updateUserSelect Debug ===');
            console.log('Users loaded:', users.length);
            console.log('Users data:', users);
            console.log('Players loaded:', players.length);
            console.log('Players data:', players);
            console.log('Existing player user IDs:', existingPlayerUserIds);
            
            // Filter out users who are already players
            const availableUsers = users.filter(user => !existingPlayerUserIds.includes(user.id));
            
            console.log('Available users:', availableUsers.length);
            console.log('Available users data:', availableUsers);
            
            // Build the dropdown HTML
            const dropdownHTML = '<option value="">-- Select a user --</option>' +
                availableUsers.map(user => 
                    `<option value="${user.id}">${user.firstName} ${user.lastName} (${user.email})</option>`
                ).join('');
            
            console.log('Dropdown HTML length:', dropdownHTML.length);
            console.log('Dropdown HTML preview:', dropdownHTML.substring(0, 200) + '...');
            
            userSelect.innerHTML = dropdownHTML;
            console.log('Dropdown updated. Options count:', userSelect.options.length);
        }

        // Update stats
        function updateStats() {
            document.getElementById('totalPlayers').textContent = players.length;
            document.getElementById('checkedInPlayers').textContent = checkedInPlayers.length;
            document.getElementById('totalUsers').textContent = users.length;
            
            const existingPlayerUserIds = players.map(p => p.user?.id).filter(id => id);
            const availableUsers = users.filter(user => !existingPlayerUserIds.includes(user.id));
            document.getElementById('availableUsers').textContent = availableUsers.length;
        }

        // Add selected user as player
        async function addSelectedUserAsPlayer() {
            const userSelect = document.getElementById('userSelect');
            const userId = userSelect.value;
            
            if (!userId) {
                alert('Please select a user first');
                return;
            }
            
            try {
                await airtableAPI.addPlayerFromUser(userId);
                await loadData();
                alert('Player added successfully!');
            } catch (error) {
                console.error('Failed to add player:', error);
                alert('Failed to add player. Please try again.');
            }
        }

        // Tab navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Remove player
        async function removePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            const playerName = airtableAPI.getPlayerDisplayName(player);
            
            if (confirm(`Are you sure you want to remove ${playerName}?`)) {
                try {
                    await airtableAPI.removePlayer(playerId);
                    await loadData();
                    alert('Player removed successfully!');
                } catch (error) {
                    console.error('Failed to remove player:', error);
                    alert('Failed to remove player. Please try again.');
                }
            }
        }

        // Toggle check-in
        async function toggleCheckin(playerId) {
            const player = players.find(p => p.id === playerId);
            const isCheckedIn = checkedInPlayers.some(cp => cp.player && cp.player.id === playerId);
            const newStatus = !isCheckedIn;
            
            try {
                await airtableAPI.toggleCheckin(playerId, newStatus);
                await loadData();
            } catch (error) {
                console.error('Failed to update check-in status:', error);
                alert('Failed to update check-in status. Please try again.');
            }
        }

        // Generate matches
        function generateMatches() {
            if (checkedInPlayers.length < 2) {
                alert('Need at least 2 checked-in players to generate matches');
                return;
            }
            
            matchQueue = [];
            const checkedInPlayerIds = checkedInPlayers.map(cp => cp.player.id);
            const minMatches = parseInt(document.getElementById('minMatches').value) || 3;
            const playerMatchCount = {};
            
            checkedInPlayerIds.forEach(playerId => {
                playerMatchCount[playerId] = 0;
            });

            let attempts = 0;
            const maxAttempts = 1000;
            
            while (attempts < maxAttempts) {
                const needsMatches = checkedInPlayerIds.filter(playerId => 
                    playerMatchCount[playerId] < minMatches
                ).sort((a, b) => playerMatchCount[a] - playerMatchCount[b]);
                
                if (needsMatches.length < 2) break;
                
                let matched = false;
                for (let i = 0; i < needsMatches.length - 1; i++) {
                    for (let j = i + 1; j < needsMatches.length; j++) {
                        const player1Id = needsMatches[i];
                        const player2Id = needsMatches[j];
                        
                        const alreadyMatched = matchQueue.some(match => 
                            (match.player1 && match.player1.id === player1Id && match.player2 && match.player2.id === player2Id) ||
                            (match.player1 && match.player1.id === player2Id && match.player2 && match.player2.id === player1Id)
                        );
                        
                        if (!alreadyMatched) {
                            const player1 = players.find(p => p.id === player1Id);
                            const player2 = players.find(p => p.id === player2Id);
                            
                            matchQueue.push({
                                player1,
                                player2,
                                status: 'pending',
                                matchNumber: matchQueue.length + 1
                            });
                            playerMatchCount[player1Id]++;
                            playerMatchCount[player2Id]++;
                            matched = true;
                            break;
                        }
                    }
                    if (matched) break;
                }
                
                if (!matched) {
                    const player1Id = needsMatches[0];
                    const player2Id = needsMatches[1];
                    const player1 = players.find(p => p.id === player1Id);
                    const player2 = players.find(p => p.id === player2Id);
                    
                    matchQueue.push({
                        player1,
                        player2,
                        status: 'pending',
                        matchNumber: matchQueue.length + 1
                    });
                    playerMatchCount[player1Id]++;
                    playerMatchCount[player2Id]++;
                }
                
                attempts++;
            }

            updateDisplay();
            saveData();
        }

        // Clear matches
        async function clearMatches() {
            if (confirm('Are you sure you want to clear all matches?')) {
                try {
                    await airtableAPI.updateMatchQueue([]);
                    matchQueue = [];
                    currentMatchIndex = 0;
                    updateDisplay();
                } catch (error) {
                    console.error('Failed to clear matches:', error);
                    alert('Failed to clear matches. Please try again.');
                }
            }
        }

        // Save data to Airtable
        async function saveData() {
            try {
                await airtableAPI.updateMatchQueue(matchQueue);
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Failed to save data:', error);
                alert('Failed to save data. Please try again.');
            }
        }

        // Save settings
        async function saveSettings() {
            const newSettings = {
                tournamentName: document.getElementById('tournamentName').value,
                minMatches: parseInt(document.getElementById('minMatches').value),
                notes: document.getElementById('tournamentNotes').value
            };
            
            try {
                await airtableAPI.updateSettings(newSettings);
                settings = { ...settings, ...newSettings };
                alert('Settings saved successfully!');
            } catch (error) {
                console.error('Failed to save settings:', error);
                alert('Failed to save settings. Please try again.');
            }
        }

        // Update settings form
        function updateSettingsForm() {
            document.getElementById('tournamentName').value = settings.tournamentName;
            document.getElementById('minMatches').value = settings.minMatches;
            document.getElementById('tournamentNotes').value = settings.notes;
        }

        // Export data
        function exportData() {
            const data = {
                players,
                matches,
                leaderboard,
                checkedInPlayers,
                matchQueue,
                currentMatchIndex,
                settings,
                lastUpdated: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'golf-league-data.json';
            downloadLink.click();
        }

        // Update display
        function updateDisplay() {
            // Update players list
            const playersList = document.getElementById('playersList');
            if (players.length === 0) {
                playersList.innerHTML = '<div class="empty-state"><h3>No Players Added</h3><p>Add players from the Users table to get started</p></div>';
            } else {
                playersList.innerHTML = players.map(player => {
                    const isCheckedIn = checkedInPlayers.some(cp => cp.player && cp.player.id === player.id);
                    const displayName = airtableAPI.getPlayerDisplayName(player);
                    return `
                        <div class="player-card">
                            <div class="player-info">
                                <h3>${displayName}</h3>
                                <p>Status: ${isCheckedIn ? 'Checked In' : 'Not Checked In'}</p>
                            </div>
                            <div class="player-actions">
                                <button class="btn btn-small" onclick="toggleCheckin('${player.id}')">
                                    ${isCheckedIn ? 'Check Out' : 'Check In'}
                                </button>
                                <button class="btn btn-small btn-danger" onclick="removePlayer('${player.id}')">
                                    Remove
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update match queue
            const matchQueueDiv = document.getElementById('matchQueue');
            if (matchQueue.length === 0) {
                matchQueueDiv.innerHTML = '<div class="empty-state"><h3>No Matches Generated</h3><p>Generate matches once players are checked in</p></div>';
            } else {
                matchQueueDiv.innerHTML = matchQueue.map((match, index) => {
                    const player1Name = airtableAPI.getPlayerDisplayName(match.player1);
                    const player2Name = airtableAPI.getPlayerDisplayName(match.player2);
                    
                    return `
                        <div class="match-card ${match.status}">
                            <div class="match-header">
                                <div class="match-number">Match ${match.matchNumber}</div>
                                <div class="match-status ${match.status}">${match.status.charAt(0).toUpperCase() + match.status.slice(1)}</div>
                            </div>
                            <div class="match-players">${player1Name} vs ${player2Name}</div>
                            <div class="match-actions">
                                ${match.status === 'pending' ? 
                                    `<button class="btn btn-small" onclick="startMatch(${index})">Start Match</button>` : 
                                    match.status === 'active' ? 
                                    '<span style="color: #256a33; font-weight: 600;">Currently Playing</span>' :
                                    '<span style="color: #256a33; font-weight: 600;">Completed</span>'
                                }
                                <button class="btn btn-small btn-danger" onclick="removeMatch(${index})">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Start match
        async function startMatch(index) {
            for (let i = 0; i < matchQueue.length; i++) {
                const match = matchQueue[i];
                const newStatus = (i === index) ? 'active' : (match.status === 'completed' ? 'completed' : 'pending');
                if (match.status !== newStatus) {
                    await airtableAPI.updateMatchStatus(match.matchNumber, newStatus);
                    match.status = newStatus;
                }
            }
            await loadData();
        }

        // Remove match
        async function removeMatch(index) {
            if (confirm('Are you sure you want to remove this match?')) {
                matchQueue.splice(index, 1);
                matchQueue.forEach((match, i) => {
                    match.matchNumber = i + 1;
                });
                updateDisplay();
                await saveData();
            }
        }

        // Initialize
        loadData();
    </script>
</body>
</html> 